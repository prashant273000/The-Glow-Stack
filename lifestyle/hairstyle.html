<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Glow Stack | AI Style Advisor</title>
    <link rel="icon" type="image/png" href="../logo.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>
    
    <style>
        :root { --bg: #050505; --accent: #bc13fe; --cyan: #00f3ff; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding-bottom: 50px; }
        .container { max-width: 500px; width: 90%; padding: 40px 0; text-align: center; }
        
        /* UPLOAD BOX */
        .upload-container {
            width: 100%; aspect-ratio: 3/4; border-radius: 24px;
            border: 2px dashed #444; background: rgba(255,255,255,0.02);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; overflow: hidden; transition: 0.3s;
        }
        .upload-container:hover { border-color: var(--accent); background: rgba(188, 19, 254, 0.05); }
        
        #preview-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .upload-icon { font-size: 3rem; color: #444; margin-bottom: 10px; }
        
        input[type="file"] { display: none; }

        .btn { 
            background: linear-gradient(135deg, var(--accent), #7000ff); 
            color: white; border: none; padding: 18px; border-radius: 50px; 
            font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px;
            text-transform: uppercase; letter-spacing: 1px; transition: 0.3s;
        }
        .btn:disabled { background: #222; opacity: 0.5; }
        
        .result-card { 
            background: rgba(255,255,255,0.05); border: 1px solid var(--accent); 
            border-radius: 20px; padding: 25px; text-align: left; margin-top: 30px; display: none; 
        }
        .status { color: var(--cyan); font-size: 0.9rem; margin-bottom: 15px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h1 style="font-family:'Space Grotesk'; font-size: 2.5rem;">Style <span style="color:var(--accent)">Analyzer</span></h1>
        <p class="status" id="status">WAKING UP AI...</p>

        <label class="upload-container" id="drop-zone">
            <div id="upload-placeholder">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <p>Click to Upload Selfie</p>
                <small style="color:#666">Clear front-facing photo works best</small>
            </div>
            <img id="preview-img" alt="Preview">
            <input type="file" id="file-input" accept="image/*">
        </label>

        <button class="btn" id="scanBtn" onclick="analyzePhoto()" disabled>Analyze My Shape</button>

        <div id="result" class="result-card">
            <h3 id="shape-header" style="color:var(--cyan); font-family: 'Space Grotesk';"></h3>
            <div id="advice-body" style="margin-top:15px; line-height:1.6; color: #ddd;"></div>
        </div>
    </div>
    <footer>
        <p style="text-align:center; color:#555; padding-bottom:20px;">© 2026 Glow Stack Inc. All Rights Reserved.</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const fileInput = document.getElementById('file-input');
        const previewImg = document.getElementById('preview-img');
        const placeholder = document.getElementById('upload-placeholder');
        const status = document.getElementById('status');
        const btn = document.getElementById('scanBtn');
        let detector;

        // 1. Initialize AI Model
        async function initAI() {
            try {
                detector = await faceLandmarksDetection.createDetector(
                    faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh,
                    { runtime: 'tfjs' }
                );
                status.innerText = "READY FOR UPLOAD ✅";
            } catch (e) {
                status.innerText = "AI FAILED TO START ❌";
            }
        }

        // 2. Handle Image Upload & Preview
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    previewImg.src = event.target.result;
                    previewImg.style.display = 'block';
                    placeholder.style.display = 'none';
                    btn.disabled = false;
                    status.innerText = "IMAGE LOADED - CLICK ANALYZE";
                };
                reader.readAsDataURL(file);
            }
        });

        // 3. Analyze the Static Image
        async function analyzePhoto() {
            if (!detector) return;
            
            btn.disabled = true;
            status.innerText = "MEASURING GEOMETRY...";

            // Run detection on the <img> element
            const faces = await detector.estimateFaces(previewImg);

            if (faces.length > 0) {
                const kp = faces[0].keypoints;
                
                // Height (Chin to Forehead) / Width (Cheek to Cheek)
                const h = kp[152].y - kp[10].y;
                const w = kp[454].x - kp[234].x;
                const ratio = h / w;

                let shape = "Oval";
                if (ratio < 1.25) shape = "Round";
                else if (ratio > 1.55) shape = "Long";
                else if (ratio >= 1.25 && ratio <= 1.55) shape = "Square";

                status.innerText = `SHAPE DETECTED: ${shape}. GETTING ADVICE...`;

                // Send the TEXT name to Groq
                try {
                    const res = await fetch('http://localhost:3000/api/style-advice', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ shape: shape, mode: 'hair' })
                    });
                    const data = await res.json();
                    
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('shape-header').innerHTML = `<i class="fas fa-check-circle"></i> Result: ${shape} Face`;
                    document.getElementById('advice-body').innerHTML = marked.parse(data.reply);
                    status.innerText = "SUCCESS ✅";
                } catch (e) {
                    alert("Groq Server Error. Check if your Node app is running!");
                }
            } else {
                status.innerText = "NO FACE DETECTED! TRY A CLEARER PHOTO.";
                alert("AI couldn't find a face. Make sure the photo is clear and front-facing.");
            }
            btn.disabled = false;
        }

        initAI();
    </script>
</body>
</html>